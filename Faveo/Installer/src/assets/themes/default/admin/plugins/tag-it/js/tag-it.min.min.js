(function(b){b.widget("ui.tagit",{options:{allowDuplicates:false,caseSensitive:true,fieldName:"tags",placeholderText:null,readOnly:false,removeConfirmation:false,tagLimit:null,availableTags:[],autocomplete:{},showAutocompleteOnFocus:false,allowSpaces:false,singleField:false,singleFieldDelimiter:",",singleFieldNode:null,animate:true,tabIndex:null,beforeTagAdded:null,afterTagAdded:null,beforeTagRemoved:null,afterTagRemoved:null,onTagClicked:null,onTagLimitExceeded:null,onTagAdded:null,onTagRemoved:null,tagSource:null},_create:function(){var g=this;if(this.element.is("input")){this.tagList=b("<ul></ul>").insertAfter(this.element);this.options.singleField=true;this.options.singleFieldNode=this.element;this.element.addClass("tagit-hidden-field")}else{this.tagList=this.element.find("ul, ol").andSelf().last()}this.tagInput=b('<input type="text" />').addClass("ui-widget-content");if(this.options.readOnly){this.tagInput.attr("disabled","disabled")}if(this.options.tabIndex){this.tagInput.attr("tabindex",this.options.tabIndex)}if(this.options.placeholderText){this.tagInput.attr("placeholder",this.options.placeholderText)}if(!this.options.autocomplete.source){this.options.autocomplete.source=function(e,f){var d=e.term.toLowerCase();var c=b.grep(this.options.availableTags,function(l){return(l.toLowerCase().indexOf(d)===0)});if(!this.options.allowDuplicates){c=this._subtractArray(c,this.assignedTags())}f(c)}}if(this.options.showAutocompleteOnFocus){this.tagInput.focus(function(d,c){g._showAutocomplete()});if(typeof this.options.autocomplete.minLength==="undefined"){this.options.autocomplete.minLength=0}}if(b.isFunction(this.options.autocomplete.source)){this.options.autocomplete.source=b.proxy(this.options.autocomplete.source,this)}if(b.isFunction(this.options.tagSource)){this.options.tagSource=b.proxy(this.options.tagSource,this)}this.tagList.addClass("tagit").addClass("ui-widget ui-widget-content ui-corner-all").append(b('<li class="tagit-new"></li>').append(this.tagInput)).click(function(c){var d=b(c.target);if(d.hasClass("tagit-label")){var e=d.closest(".tagit-choice");if(!e.hasClass("removed")){g._trigger("onTagClicked",c,{tag:e,tagLabel:g.tagLabel(e)})}}else{g.tagInput.focus()}});var i=false;if(this.options.singleField){if(this.options.singleFieldNode){var h=b(this.options.singleFieldNode);var j=h.val().split(this.options.singleFieldDelimiter);h.val("");b.each(j,function(c,d){g.createTag(d,null,true);i=true})}else{this.options.singleFieldNode=b('<input type="hidden" style="display:none;" value="" name="'+this.options.fieldName+'" />');this.tagList.after(this.options.singleFieldNode)}}if(!i){this.tagList.children("li").each(function(){if(!b(this).hasClass("tagit-new")){g.createTag(b(this).text(),b(this).attr("class"),true);b(this).remove()}})}this.tagInput.keydown(function(c){if(c.which==b.ui.keyCode.BACKSPACE&&g.tagInput.val()===""){var d=g._lastTag();if(!g.options.removeConfirmation||d.hasClass("remove")){g.removeTag(d)}else{if(g.options.removeConfirmation){d.addClass("remove ui-state-highlight")}}}else{if(g.options.removeConfirmation){g._lastTag().removeClass("remove ui-state-highlight")}}if((c.which===b.ui.keyCode.COMMA&&c.shiftKey===false)||c.which===b.ui.keyCode.ENTER||(c.which==b.ui.keyCode.TAB&&g.tagInput.val()!=="")||(c.which==b.ui.keyCode.SPACE&&g.options.allowSpaces!==true&&(b.trim(g.tagInput.val()).replace(/^s*/,"").charAt(0)!='"'||(b.trim(g.tagInput.val()).charAt(0)=='"'&&b.trim(g.tagInput.val()).charAt(b.trim(g.tagInput.val()).length-1)=='"'&&b.trim(g.tagInput.val()).length-1!==0)))){if(!(c.which===b.ui.keyCode.ENTER&&g.tagInput.val()==="")){c.preventDefault()}if(!(g.options.autocomplete.autoFocus&&g.tagInput.data("autocomplete-open"))){g.tagInput.autocomplete("close");g.createTag(g._cleanedInput())}}}).blur(function(c){if(!g.tagInput.data("autocomplete-open")){g.createTag(g._cleanedInput())}});if(this.options.availableTags||this.options.tagSource||this.options.autocomplete.source){var a={select:function(d,c){g.createTag(c.item.value);return false}};b.extend(a,this.options.autocomplete);a.source=this.options.tagSource||a.source;this.tagInput.autocomplete(a).bind("autocompleteopen.tagit",function(d,c){g.tagInput.data("autocomplete-open",true)}).bind("autocompleteclose.tagit",function(d,c){g.tagInput.data("autocomplete-open",false)});this.tagInput.autocomplete("widget").addClass("tagit-autocomplete")}},destroy:function(){b.Widget.prototype.destroy.call(this);this.element.unbind(".tagit");this.tagList.unbind(".tagit");this.tagInput.removeData("autocomplete-open");this.tagList.removeClass(["tagit","ui-widget","ui-widget-content","ui-corner-all","tagit-hidden-field"].join(" "));if(this.element.is("input")){this.element.removeClass("tagit-hidden-field");this.tagList.remove()}else{this.element.children("li").each(function(){if(b(this).hasClass("tagit-new")){b(this).remove()}else{b(this).removeClass(["tagit-choice","ui-widget-content","ui-state-default","ui-state-highlight","ui-corner-all","remove","tagit-choice-editable","tagit-choice-read-only"].join(" "));b(this).text(b(this).children(".tagit-label").text())}});if(this.singleFieldNode){this.singleFieldNode.remove()}}return this},_cleanedInput:function(){return b.trim(this.tagInput.val().replace(/^"(.*)"$/,"$1"))},_lastTag:function(){return this.tagList.find(".tagit-choice:last:not(.removed)")},_tags:function(){return this.tagList.find(".tagit-choice:not(.removed)")},assignedTags:function(){var d=this;var a=[];if(this.options.singleField){a=b(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter);if(a[0]===""){a=[]}}else{this._tags().each(function(){a.push(d.tagLabel(this))})}return a},_updateSingleTagsField:function(a){b(this.options.singleFieldNode).val(a.join(this.options.singleFieldDelimiter)).trigger("change")},_subtractArray:function(g,h){var a=[];for(var f=0;f<g.length;f++){if(b.inArray(g[f],h)==-1){a.push(g[f])}}return a},tagLabel:function(a){if(this.options.singleField){return b(a).find(".tagit-label:first").text()}else{return b(a).find("input:first").val()}},_showAutocomplete:function(){this.tagInput.autocomplete("search","")},_findTagByLabel:function(f){var e=this;var a=null;this._tags().each(function(c){if(e._formatStr(f)==e._formatStr(e.tagLabel(this))){a=b(this);return false}});return a},_isNew:function(a){return !this._findTagByLabel(a)},_formatStr:function(a){if(this.options.caseSensitive){return a}return b.trim(a.toLowerCase())},_effectExists:function(a){return Boolean(b.effects&&(b.effects[a]||(b.effects.effect&&b.effects.effect[a])))},createTag:function(o,r,v){var s=this;o=b.trim(o);if(this.options.preprocessTag){o=this.options.preprocessTag(o)}if(o===""){return false}if(!this.options.allowDuplicates&&!this._isNew(o)){var t=this._findTagByLabel(o);if(this._trigger("onTagExists",null,{existingTag:t,duringInitialization:v})!==false){if(this._effectExists("highlight")){t.effect("highlight")}}return false}if(this.options.tagLimit&&this._tags().length>=this.options.tagLimit){this._trigger("onTagLimitExceeded",null,{duringInitialization:v});return false}var p=b(this.options.onTagClicked?'<a class="tagit-label"></a>':'<span class="tagit-label"></span>').text(o);var a=b("<li></li>").addClass("tagit-choice ui-widget-content ui-state-default ui-corner-all").addClass(r).append(p);if(this.options.readOnly){a.addClass("tagit-choice-read-only")}else{a.addClass("tagit-choice-editable");var u=b("<span></span>").addClass("ui-icon ui-icon-close");var q=b('<a><span class="text-icon">\xd7</span></a>').addClass("tagit-close").append(u).click(function(c){s.removeTag(a)});a.append(q)}if(!this.options.singleField){var m=p.html();a.append('<input type="hidden" value="'+m+'" name="'+this.options.fieldName+'" class="tagit-hidden-field" />')}if(this._trigger("beforeTagAdded",null,{tag:a,tagLabel:this.tagLabel(a),duringInitialization:v})===false){return}if(this.options.singleField){var n=this.assignedTags();n.push(o);this._updateSingleTagsField(n)}this._trigger("onTagAdded",null,a);this.tagInput.val("");this.tagInput.parent().before(a);this._trigger("afterTagAdded",null,{tag:a,tagLabel:this.tagLabel(a),duringInitialization:v});if(this.options.showAutocompleteOnFocus&&!v){setTimeout(function(){s._showAutocomplete()},0)}},removeTag:function(a,k){k=typeof k==="undefined"?this.options.animate:k;a=b(a);this._trigger("onTagRemoved",null,a);if(this._trigger("beforeTagRemoved",null,{tag:a,tagLabel:this.tagLabel(a)})===false){return}if(this.options.singleField){var i=this.assignedTags();var j=this.tagLabel(a);i=b.grep(i,function(c){return c!=j});this._updateSingleTagsField(i)}if(k){a.addClass("removed");var h=this._effectExists("blind")?["blind",{direction:"horizontal"},"fast"]:["fast"];var l=this;h.push(function(){a.remove();l._trigger("afterTagRemoved",null,{tag:a,tagLabel:l.tagLabel(a)})});a.fadeOut("fast").hide.apply(a,h).dequeue()}else{a.remove();this._trigger("afterTagRemoved",null,{tag:a,tagLabel:this.tagLabel(a)})}},removeTagByLabel:function(e,a){var f=this._findTagByLabel(e);if(!f){throw"No such tag exists with the name '"+e+"'"}this.removeTag(f,a)},removeAll:function(){var a=this;this._tags().each(function(e,f){a.removeTag(f,false)})}})})(jQuery);