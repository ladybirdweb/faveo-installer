(function(e,f,i,c){var g=e.extend;var l=e.each;function d(m,o,n){if(m.addEventListener){m.addEventListener(o,n,!1)}else{if(m.attachEvent){m.attachEvent("on"+o,n)}else{m["on"+o]=n}}}function h(m,o,n){if(m.removeEventListener){m.removeEventListener(o,n,!1)}else{if(m.detachEvent){m.detachEvent("on"+o,n)}else{m["on"+o]=null}}}function k(m){m.parentNode.removeChild(m)}function a(m){var n={};return m&&n.toString.call(m)==="[object Function]"}function b(m){this.support=!1;this.files=[];this.events=[];this.defaults={simultaneousUploads:3,fileParameterName:"file",query:{},target:"/",generateUniqueIdentifier:null,matchJSON:!1};var n=this;this.inputChangeEvent=function(q){var p=q.srcElement;h(p,"change",n.inputChangeEvent);var o=p.cloneNode(!1);p.parentNode.replaceChild(o,p);n.addFile(p,q);o.value="";d(o,"change",n.inputChangeEvent)};this.opts=e.extend({},this.defaults,m||{})}b.prototype={on:e.prototype.on,fire:e.prototype.fire,cancel:e.prototype.cancel,assignBrowse:function(m){if(typeof m.length=="undefined"){m=[m]}l(m,function(o){var n;if(o.tagName==="INPUT"&&o.type==="file"){n=o}else{n=i.createElement("input");n.setAttribute("type","file");g(o.style,{display:"inline-block",position:"relative",overflow:"hidden",verticalAlign:"top"});g(n.style,{position:"absolute",top:0,right:0,fontFamily:"Arial",fontSize:"118px",margin:0,padding:0,opacity:0,filter:"alpha(opacity=0)",cursor:"pointer"});o.appendChild(n)}d(n,"change",this.inputChangeEvent)},this)},assignDrop:function(){},unAssignDrop:function(){},isUploading:function(){var m=!1;l(this.files,function(n){if(n.isUploading()){m=!0;return !1}});return m},upload:function(){var m=0;l(this.files,function(n){if(n.progress()==1){return}if(n.isUploading()){m++;return}if(m++>=this.opts.simultaneousUploads){return !1}if(m==1){this.fire("uploadStart")}n.send()},this);if(!m){this.fire("complete")}},pause:function(){l(this.files,function(m){m.abort()})},resume:function(){this.upload()},progress:function(){var n=0;var m=0;l(this.files,function(o){n+=o.progress();m++});return m>0?n/m:0},addFiles:function(o,n){var m=[];l(o,function(p){if(p.nodeType===1&&p.value){var q=new j(this,p);if(this.fire("fileAdded",q,n)){m.push(q)}}},this);if(this.fire("filesAdded",m,n)){l(m,function(p){if(this.opts.singleFile&&this.files.length>0){this.removeFile(this.files[0])}this.files.push(p)},this)}this.fire("filesSubmitted",m,n)},addFile:function(m,n){this.addFiles([m],n)},generateUniqueIdentifier:function(m){var n=this.opts.generateUniqueIdentifier;if(typeof n==="function"){return n(m)}return"xxxxxxxx-xxxx-yxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(q){var p=Math.random()*16|0,o=q=="x"?p:(p&3|8);return o.toString(16)})},getFromUniqueIdentifier:function(m){var n=!1;l(this.files,function(o){if(o.uniqueIdentifier==m){n=o}});return n},removeFile:function(n){for(var m=this.files.length-1;m>=0;m--){if(this.files[m]===n){this.files.splice(m,1)}}},getSize:function(){},timeRemaining:function(){},sizeUploaded:function(){}};function j(m,n){this.flowObj=m;this.element=n;this.name=n.value&&n.value.replace(/.*(\/|\\)/,"");this.relativePath=this.name;this.uniqueIdentifier=m.generateUniqueIdentifier(n);this.iFrame=null;this.finished=!1;this.error=!1;var o=this;this.iFrameLoaded=function(r){if(!o.iFrame||!o.iFrame.parentNode){return}o.finished=!0;try{if(o.iFrame.contentDocument&&o.iFrame.contentDocument.body&&o.iFrame.contentDocument.body.innerHTML=="false"){return}}catch(q){o.error=!0;o.abort();o.flowObj.fire("fileError",o,q);return}var s=o.iFrame.contentDocument||o.iFrame.contentWindow.document;var p=s.body.innerHTML;if(o.flowObj.opts.matchJSON){p=/(\{.*\})/.exec(p)[0]}o.abort();o.flowObj.fire("fileSuccess",o,p);o.flowObj.upload()};this.bootstrap()}j.prototype={getExtension:e.FlowFile.prototype.getExtension,getType:function(){},send:function(){if(this.finished){return}var p=this.flowObj.opts;var m=this.createForm();var n=p.query;if(a(n)){n=n(this)}n[p.fileParameterName]=this.element;n.flowFilename=this.name;n.flowRelativePath=this.relativePath;n.flowIdentifier=this.uniqueIdentifier;this.addFormParams(m,n);d(this.iFrame,"load",this.iFrameLoaded);m.submit();k(m)},abort:function(){if(this.iFrame){this.iFrame.setAttribute("src","java"+String.fromCharCode(115)+"cript:false;");k(this.iFrame);this.iFrame=null}},cancel:function(){this.abort();this.flowObj.removeFile(this)},retry:function(){this.bootstrap();this.flowObj.upload()},bootstrap:function(){this.abort();this.error=!1},timeRemaining:function(){},sizeUploaded:function(){},resume:function(){this.flowObj.upload()},pause:function(){this.abort()},isUploading:function(){return this.iFrame!==null},isComplete:function(){return this.progress()===1},progress:function(){if(this.error){return 1}return this.finished?1:0},createIframe:function(){var m=(/MSIE (6|7|8)/).test(navigator.userAgent)?i.createElement('<iframe name="'+this.uniqueIdentifier+'_iframe">'):i.createElement("iframe");m.setAttribute("id",this.uniqueIdentifier+"_iframe_id");m.setAttribute("name",this.uniqueIdentifier+"_iframe");m.style.display="none";i.body.appendChild(m);return m},createForm:function(){var n=this.flowObj.opts.target;var m=i.createElement("form");m.encoding="multipart/form-data";m.method="POST";m.setAttribute("action",n);if(!this.iFrame){this.iFrame=this.createIframe()}m.setAttribute("target",this.iFrame.name);m.style.display="none";i.body.appendChild(m);return m},addFormParams:function(n,o){var m;l(o,function(q,p){if(q&&q.nodeType===1){m=q}else{m=i.createElement("input");m.setAttribute("value",q)}m.setAttribute("name",p);n.appendChild(m)})}};b.FustyFlowFile=j;if(typeof module!=="undefined"){module.exports=b}else{if(typeof define==="function"&&define.amd){define(function(){return b})}else{f.FustyFlow=b}}})(window.Flow,window,document);